<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="com.dzvote.vote.mapper.VoteLimitMapper">

    <!-- 结果映射 -->
    <resultMap id="BaseResultMap" type="com.dzvote.vote.entity.VoteLimit">
        <id column="id" property="id" jdbcType="BIGINT"/>
        <result column="activity_id" property="activityId" jdbcType="BIGINT"/>
        <result column="voter_phone" property="voterPhone" jdbcType="VARCHAR"/>
        <result column="voter_ip" property="voterIp" jdbcType="VARCHAR"/>
        <result column="vote_count" property="voteCount" jdbcType="INTEGER"/>
        <result column="last_vote_time" property="lastVoteTime" jdbcType="TIMESTAMP"/>
        <result column="created_at" property="createdAt" jdbcType="TIMESTAMP"/>
        <result column="updated_at" property="updatedAt" jdbcType="TIMESTAMP"/>
    </resultMap>

    <!-- 插入或更新投票限制记录 -->
    <insert id="upsert" parameterType="com.dzvote.vote.entity.VoteLimit">
        INSERT INTO vote_limits (
            activity_id, voter_phone, voter_ip, vote_count,
            last_vote_time, created_at, updated_at
        ) VALUES (
            #{activityId}, #{voterPhone}, #{voterIp}, #{voteCount},
            #{lastVoteTime}, #{createdAt}, #{updatedAt}
        )
        ON DUPLICATE KEY UPDATE
            vote_count = vote_count + #{voteCount},
            last_vote_time = #{lastVoteTime},
            updated_at = #{updatedAt}
    </insert>

    <!-- 查询投票限制 -->
    <select id="findByPhoneAndActivity" resultMap="BaseResultMap">
        SELECT id, activity_id, voter_phone, voter_ip, vote_count,
               last_vote_time, created_at, updated_at
        FROM vote_limits
        WHERE activity_id = #{activityId}
        AND voter_phone = #{voterPhone}
        LIMIT 1
    </select>

    <!-- 查询投票限制（带IP） -->
    <select id="findByPhoneIpAndActivity" resultMap="BaseResultMap">
        SELECT id, activity_id, voter_phone, voter_ip, vote_count,
               last_vote_time, created_at, updated_at
        FROM vote_limits
        WHERE activity_id = #{activityId}
        AND voter_phone = #{voterPhone}
        AND voter_ip = #{voterIp}
        LIMIT 1
    </select>

    <!-- 重置投票限制 -->
    <update id="reset" parameterType="com.dzvote.vote.entity.VoteLimit">
        UPDATE vote_limits
        SET vote_count = 0, updated_at = NOW()
        WHERE activity_id = #{activityId}
        AND voter_phone = #{voterPhone}
    </update>

</mapper>
