<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="Content-Type" content="text/html; charset=utf-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>åœ¨çº¿æŠ•ç¥¨ç³»ç»Ÿ</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body {
            font-family: 'Segoe UI', Arial, sans-serif;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            min-height: 100vh;
            padding: 20px 0;
        }
        .container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 0 20px;
        }

        /* Header */
        .header {
            background: white;
            padding: 30px;
            border-radius: 15px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
            margin-bottom: 30px;
            text-align: center;
        }
        .header h1 {
            color: #1e3c72;
            margin-bottom: 10px;
            font-size: 32px;
        }
        .header p {
            color: #666;
            font-size: 16px;
        }

        /* Activity Selector */
        .activity-selector {
            background: white;
            padding: 20px;
            border-radius: 10px;
            margin-bottom: 20px;
            box-shadow: 0 2px 10px rgba(0,0,0,0.05);
            display: flex;
            gap: 15px;
            align-items: center;
        }
        .activity-selector select {
            flex: 1;
            padding: 12px;
            border: 2px solid #667eea;
            border-radius: 8px;
            font-size: 16px;
            cursor: pointer;
        }

        /* Stats */
        .stats {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 20px;
            margin-bottom: 30px;
        }
        .stat-card {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            text-align: center;
            transition: transform 0.3s;
        }
        .stat-card:hover {
            transform: translateY(-5px);
        }
        .stat-value {
            font-size: 40px;
            color: #667eea;
            font-weight: bold;
            margin-bottom: 5px;
        }
        .stat-label {
            color: #666;
            font-size: 14px;
        }

        /* Candidate Grid */
        .candidate-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(300px, 1fr));
            gap: 25px;
            margin-top: 20px;
        }
        .candidate-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 4px 15px rgba(0,0,0,0.08);
            transition: all 0.3s;
            position: relative;
        }
        .candidate-card:hover {
            transform: translateY(-8px);
            box-shadow: 0 8px 25px rgba(102, 126, 234, 0.3);
        }

        /* Candidate Rank Badge */
        .rank-badge {
            position: absolute;
            top: 10px;
            right: 10px;
            width: 50px;
            height: 50px;
            border-radius: 50%;
            display: flex;
            align-items: center;
            justify-content: center;
            font-size: 24px;
            font-weight: bold;
            box-shadow: 0 2px 10px rgba(0,0,0,0.2);
        }
        .rank-1 { background: linear-gradient(135deg, #FFD700, #FFA500); color: white; }
        .rank-2 { background: linear-gradient(135deg, #C0C0C0, #A9A9A9); color: white; }
        .rank-3 { background: linear-gradient(135deg, #CD7F32, #8B4513); color: white; }
        .rank-other { background: linear-gradient(135deg, #667eea, #764ba2); color: white; }

        .candidate-avatar {
            width: 100%;
            height: 220px;
            object-fit: cover;
            background: #f5f5f5;
            display: flex;
            align-items: center;
            justify-content: center;
            color: #999;
            font-size: 48px;
        }
        .candidate-avatar img {
            width: 100%;
            height: 100%;
            object-fit: cover;
        }
        .candidate-info {
            padding: 20px;
        }
        .candidate-name {
            font-size: 22px;
            font-weight: bold;
            color: #1e3c72;
            margin-bottom: 8px;
        }
        .candidate-desc {
            color: #666;
            font-size: 14px;
            line-height: 1.6;
            margin-bottom: 15px;
            min-height: 40px;
        }

        /* Vote Progress */
        .vote-section {
            display: flex;
            align-items: center;
            gap: 15px;
            margin-bottom: 15px;
        }
        .vote-count {
            flex: 1;
            text-align: center;
            padding: 10px;
            background: #f8f9fa;
            border-radius: 8px;
        }
        .vote-number {
            font-size: 28px;
            color: #667eea;
            font-weight: bold;
        }
        .vote-label {
            font-size: 12px;
            color: #666;
        }
        .vote-progress {
            flex: 2;
            height: 8px;
            background: #e9ecef;
            border-radius: 4px;
            overflow: hidden;
        }
        .vote-progress-fill {
            height: 100%;
            background: linear-gradient(90deg, #667eea, #764ba2);
            transition: width 0.5s;
        }

        .vote-btn {
            width: 100%;
            padding: 15px;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            border: none;
            border-radius: 10px;
            cursor: pointer;
            font-size: 18px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .vote-btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .vote-btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }

        /* Login */
        .login-section {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 400px;
            margin: 0 auto 30px;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .login-section h2 {
            text-align: center;
            margin-bottom: 30px;
            color: #667eea;
        }
        .form-group {
            margin-bottom: 20px;
        }
        .form-group label {
            display: block;
            margin-bottom: 8px;
            font-weight: 500;
            color: #333;
        }
        .form-group input {
            width: 100%;
            padding: 12px;
            border: 2px solid #e9ecef;
            border-radius: 8px;
            font-size: 16px;
            transition: border-color 0.3s;
        }
        .form-group input:focus {
            outline: none;
            border-color: #667eea;
        }
        .btn {
            padding: 12px 30px;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            font-size: 16px;
            font-weight: bold;
            transition: all 0.3s;
        }
        .btn:hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 4px 15px rgba(102, 126, 234, 0.4);
        }
        .btn:disabled {
            background: #ccc;
            cursor: not-allowed;
            transform: none;
        }
        .btn-logout {
            background: linear-gradient(135deg, #f093fb, #f5576c);
            margin-top: 20px;
        }

        /* Alert */
        .alert {
            padding: 15px 20px;
            border-radius: 8px;
            margin-bottom: 20px;
            font-weight: 500;
        }
        .alert.success {
            background: #d4edda;
            color: #155724;
            border-left: 4px solid #28a745;
        }
        .alert.error {
            background: #f8d7da;
            color: #721c24;
            border-left: 4px solid #dc3545;
        }
        .alert.warning {
            background: #fff3cd;
            color: #856404;
            border-left: 4px solid #ffc107;
        }

        /* Sort Buttons */
        .sort-buttons {
            background: white;
            padding: 15px;
            border-radius: 10px;
            margin-bottom: 20px;
            display: flex;
            gap: 10px;
            align-items: center;
        }
        .sort-buttons label {
            font-weight: bold;
            color: #333;
            margin-right: 10px;
        }
        .sort-btn {
            padding: 8px 20px;
            border: 2px solid #667eea;
            background: white;
            color: #667eea;
            border-radius: 6px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        .sort-btn:hover {
            background: #667eea;
            color: white;
        }
        .sort-btn.active {
            background: #667eea;
            color: white;
        }

        /* Custom Modal */
        .modal-overlay {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.5);
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 1000;
            animation: fadeIn 0.3s ease;
        }
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        .modal {
            background: white;
            border-radius: 20px;
            padding: 30px;
            max-width: 450px;
            width: 90%;
            box-shadow: 0 20px 60px rgba(0, 0, 0, 0.3);
            animation: slideIn 0.3s ease;
        }
        @keyframes slideIn {
            from {
                transform: translateY(-30px);
                opacity: 0;
            }
            to {
                transform: translateY(0);
                opacity: 1;
            }
        }
        .modal-header {
            display: flex;
            align-items: center;
            gap: 12px;
            margin-bottom: 20px;
        }
        .modal-icon {
            font-size: 40px;
            line-height: 1;
        }
        .modal-title {
            font-size: 24px;
            font-weight: bold;
            color: #1e3c72;
        }
        .modal-body {
            font-size: 16px;
            color: #666;
            line-height: 1.8;
            margin-bottom: 25px;
        }
        .modal-body-text {
            margin-bottom: 10px;
        }
        .modal-buttons {
            display: flex;
            gap: 12px;
        }
        .modal-btn {
            flex: 1;
            padding: 14px;
            border: none;
            border-radius: 10px;
            font-size: 16px;
            font-weight: bold;
            cursor: pointer;
            transition: all 0.3s;
        }
        .modal-btn-primary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        .modal-btn-primary:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        .modal-btn-secondary {
            background: #e9ecef;
            color: #666;
        }
        .modal-btn-secondary:hover {
            background: #dee2e6;
        }
        .modal-btn-danger {
            background: linear-gradient(135deg, #ff6b6b, #ee5a5a);
            color: white;
        }
        .modal-btn-danger:hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 107, 107, 0.4);
        }

        /* Toast Notification */
        .toast {
            position: fixed;
            top: 20px;
            left: 50%;
            transform: translateX(-50%);
            padding: 16px 30px;
            border-radius: 12px;
            font-size: 16px;
            font-weight: 500;
            box-shadow: 0 8px 30px rgba(0, 0, 0, 0.15);
            z-index: 2000;
            animation: slideDown 0.4s ease, fadeOut 0.4s ease 2.6s;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        @keyframes slideDown {
            from {
                transform: translateX(-50%) translateY(-50px);
                opacity: 0;
            }
            to {
                transform: translateX(-50%) translateY(0);
                opacity: 1;
            }
        }
        @keyframes fadeOut {
            from { opacity: 1; }
            to { opacity: 0; }
        }
        .toast-success {
            background: linear-gradient(135deg, #00c853, #00e676);
            color: white;
        }
        .toast-error {
            background: linear-gradient(135deg, #ff5252, #ff1744);
            color: white;
        }
        .toast-warning {
            background: linear-gradient(135deg, #ffa726, #ff9800);
            color: white;
        }
        .toast-info {
            background: linear-gradient(135deg, #448aff, #2979ff);
            color: white;
        }
        .toast-icon {
            font-size: 22px;
        }

        /* Responsive */
        @media (max-width: 768px) {
            .candidate-grid {
                grid-template-columns: 1fr;
            }
            .stats {
                grid-template-columns: 1fr;
            }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Header -->
        <div class="header">
            <h1>ğŸ¯ åœ¨çº¿æŠ•ç¥¨ç³»ç»Ÿ</h1>
            <p>ä¸ºå¿ƒä»ªçš„å€™é€‰äººæŠ•ä¸Šä¸€ç¥¨ï¼Œæ¯äººæ¯æ´»åŠ¨é™æŠ• {{ voteLimit }} ç¥¨</p>
        </div>

        <div class="container">
            <!-- Login Section -->
            <div v-if="!token" class="login-section">
                <h2>ğŸ‘¤ ç”¨æˆ·ç™»å½•</h2>
                <div v-if="message" :class="['alert', messageType]">{{ message }}</div>
                <div class="form-group">
                    <label>æ‰‹æœºå·ï¼ˆå¯é€‰ï¼‰</label>
                    <input v-model="loginForm.phone" type="text" placeholder="è¯·è¾“å…¥æ‰‹æœºå·ï¼Œç”¨äºé˜²åˆ·ç¥¨">
                </div>
                <div class="form-group">
                    <label>ç”¨æˆ·åï¼ˆå¯é€‰ï¼‰</label>
                    <input v-model="loginForm.username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
                </div>
                <button class="btn" @click="login" :disabled="loading" style="width: 100%;">
                    {{ loading ? 'ç™»å½•ä¸­...' : 'ğŸš€ å¼€å§‹æŠ•ç¥¨' }}
                </button>
            </div>

            <!-- Vote Section -->
            <div v-else>
                <!-- Activity Selector -->
                <div class="activity-selector">
                    <label>ğŸ“‹ é€‰æ‹©æ´»åŠ¨ï¼š</label>
                    <select v-model="selectedActivityId" @change="loadCandidates">
                        <option value="">è¯·é€‰æ‹©æ´»åŠ¨</option>
                        <option v-for="activity in activities" :key="activity.id" :value="activity.id">
                            {{ activity.title }}
                        </option>
                    </select>
                </div>

                <!-- Stats -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value">{{ totalVotes }}</div>
                        <div class="stat-label">ğŸ“Š æ€»ç¥¨æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ candidates.length }}</div>
                        <div class="stat-label">ğŸ‘¥ å€™é€‰äººæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ voteRemaining }}</div>
                        <div class="stat-label">ğŸ« å‰©ä½™ç¥¨æ•°</div>
                    </div>
                </div>

                <!-- Alert -->
                <div v-if="message" :class="['alert', messageType]">
                    {{ message }}
                </div>

                <!-- Sort Buttons -->
                <div class="sort-buttons">
                    <label>æ’åºæ–¹å¼ï¼š</label>
                    <button :class="['sort-btn', {active: sortBy === 'votes'}]" @click="sortBy = 'votes'">
                        ğŸ† æŒ‰ç¥¨æ•°
                    </button>
                    <button :class="['sort-btn', {active: sortBy === 'order'}]" @click="sortBy = 'order'">
                        ğŸ“‹ æŒ‰é¡ºåº
                    </button>
                </div>

                <!-- Candidate Grid -->
                <div class="candidate-grid">
                    <div v-for="(candidate, index) in sortedCandidates" :key="candidate.id" class="candidate-card">
                        <!-- Rank Badge -->
                        <div v-if="sortBy === 'votes' && index < 3"
                             :class="['rank-badge', 'rank-' + (index + 1)]">
                            {{ index + 1 }}
                        </div>
                        <div v-else-if="sortBy === 'votes'"
                             :class="['rank-badge', 'rank-other']">
                            {{ index + 1 }}
                        </div>

                        <!-- Avatar -->
                        <div class="candidate-avatar">
                            <img v-if="candidate.avatar" :src="getAvatarUrl(candidate.avatar)" :alt="candidate.name">
                            <span v-else>ğŸ“·</span>
                        </div>

                        <!-- Info -->
                        <div class="candidate-info">
                            <div class="candidate-name">{{ candidate.name }}</div>
                            <div class="candidate-desc">{{ truncateDescription(candidate.description) }}</div>

                            <!-- Vote Progress -->
                            <div class="vote-section">
                                <div class="vote-count">
                                    <div class="vote-number">{{ candidate.votes }}</div>
                                    <div class="vote-label">ç¥¨</div>
                                </div>
                                <div class="vote-progress">
                                    <div class="vote-progress-fill"
                                         :style="{width: getVotePercentage(candidate.votes) + '%'}"></div>
                                </div>
                            </div>

                            <!-- Vote Button -->
                            <button class="vote-btn"
                                    @click="vote(candidate.id)"
                                    :disabled="voting || votedCandidates[candidate.id]">
                                <span v-if="voting">æŠ•ç¥¨ä¸­...</span>
                                <span v-else-if="votedCandidates[candidate.id]">âœ“ å·²æŠ•ç¥¨</span>
                                <span v-else>ğŸ‰ ä¸ºTAæŠ•ç¥¨</span>
                            </button>
                        </div>
                    </div>
                </div>

                <!-- Clear Vote Data -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn" @click="clearVoteData" style="background: linear-gradient(135deg, #f39c12, #e67e22);">
                        ğŸ”„ æ¸…é™¤æŠ•ç¥¨è®°å½•
                    </button>
                </div>

                <!-- Logout -->
                <div style="text-align: center; margin-top: 20px;">
                    <button class="btn btn-logout" @click="logout">
                        ğŸšª é€€å‡ºç™»å½•
                    </button>
                </div>
            </div>
        </div>

        <!-- Custom Modal -->
        <div v-if="modal.show" class="modal-overlay" @click.self="closeModal">
            <div class="modal">
                <div class="modal-header">
                    <div class="modal-icon">{{ modal.icon }}</div>
                    <div class="modal-title">{{ modal.title }}</div>
                </div>
                <div class="modal-body">
                    <div v-for="(text, index) in modal.content" :key="index" class="modal-body-text">
                        {{ text }}
                    </div>
                </div>
                <div class="modal-buttons">
                    <button v-if="modal.showCancel" class="modal-btn modal-btn-secondary" @click="closeModal">
                        {{ modal.cancelText || 'å–æ¶ˆ' }}
                    </button>
                    <button class="modal-btn" :class="modal.buttonClass" @click="modal.onConfirm">
                        {{ modal.confirmText || 'ç¡®å®š' }}
                    </button>
                </div>
            </div>
        </div>

        <!-- Toast Notification -->
        <div v-if="toast.show" :class="['toast', toast.type]">
            <span class="toast-icon">{{ toast.icon }}</span>
            <span>{{ toast.message }}</span>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    token: localStorage.getItem('token'),
                    totalVotes: 0,
                    candidates: [],
                    activities: [],
                    selectedActivityId: null,
                    sortBy: 'votes', // 'votes' æˆ– 'order'
                    loginForm: {
                        phone: '',
                        username: ''
                    },
                    loading: false,
                    voting: false,
                    // è®°å½•æ•´ä¸ªæ´»åŠ¨å·²æŠ•çš„æ€»ç¥¨æ•°ï¼štotal_votes_{activityId}
                    totalVotedCount: 0,
                    // è®°å½•æ¯ä¸ªå€™é€‰äººçš„æŠ•ç¥¨çŠ¶æ€ï¼švoted_candidate_{activityId}_{candidateId}
                    votedCandidates: {},
                    message: '',
                    messageType: '',
                    // Modal
                    modal: {
                        show: false,
                        icon: '',
                        title: '',
                        content: [],
                        confirmText: 'ç¡®å®š',
                        cancelText: 'å–æ¶ˆ',
                        showCancel: false,
                        buttonClass: 'modal-btn-primary',
                        onConfirm: () => {}
                    },
                    // Toast
                    toast: {
                        show: false,
                        icon: '',
                        message: '',
                        type: 'toast-success',
                        timeout: null
                    }
                }
            },
            computed: {
                sortedCandidates() {
                    let result = [...this.candidates];
                    if (this.sortBy === 'votes') {
                        result.sort((a, b) => b.votes - a.votes);
                    } else if (this.sortBy === 'order') {
                        result.sort((a, b) => (a.orderNum || 0) - (b.orderNum || 0));
                    }
                    return result;
                },
                votePercentage() {
                    if (this.candidates.length === 0) return '0%';
                    const totalVoted = this.candidates.filter(c => c.votes > 0).length;
                    return Math.round((totalVoted / this.candidates.length) * 100) + '%';
                },
                voteLimit() {
                    const activity = this.activities.find(a => a.id === this.selectedActivityId);
                    return activity ? (activity.voteLimit || 10) : 10;
                },
                voteRemaining() {
                    return Math.max(0, this.voteLimit - this.totalVotedCount);
                }
            },
            mounted() {
                if (this.token) {
                    this.loadActivities();
                }
            },
            methods: {
                login() {
                    this.loading = true;
                    this.message = '';
                    try {
                        // è®¾ç½®ä¸€ä¸ªç®€å•tokenï¼Œå®é™…é¡¹ç›®ä¸­éœ€è¦è°ƒç”¨åç«¯ç™»å½•æ¥å£
                        this.token = 'token_' + Date.now();
                        localStorage.setItem('token', this.token);
                        this.message = 'ç™»å½•æˆåŠŸï¼Œå¼€å§‹æŠ•ç¥¨å§ï¼';
                        this.messageType = 'success';
                        this.loadActivities();
                    } catch (error) {
                        this.message = 'ç™»å½•å¤±è´¥: ' + error.message;
                        this.messageType = 'error';
                    }
                    this.loading = false;
                },

                logout() {
                    localStorage.removeItem('token');
                    // æ¸…ç†æ‰€æœ‰è¯¥æ´»åŠ¨çš„æŠ•ç¥¨è®°å½•
                    if (this.selectedActivityId) {
                        const prefix1 = 'total_votes_' + this.selectedActivityId;
                        const prefix2 = 'voted_candidate_' + this.selectedActivityId + '_';
                        for (let i = 0; i < localStorage.length; i++) {
                            const key = localStorage.key(i);
                            if (key && (key === prefix1 || key.startsWith(prefix2))) {
                                localStorage.removeItem(key);
                            }
                        }
                    }
                    this.token = null;
                    this.candidates = [];
                    this.selectedActivityId = null;
                    this.totalVotedCount = 0;
                    this.votedCandidates = {};
                    this.message = '';
                },

                clearVoteData() {
                    this.showConfirm({
                        icon: 'âš ï¸',
                        title: 'ç¡®è®¤æ¸…é™¤æŠ•ç¥¨è®°å½•',
                        content: [
                            'æ¸…é™¤åæ‚¨å¯ä»¥é‡æ–°æŠ•ç¥¨',
                            'ä½†ä¹‹å‰çš„æŠ•ç¥¨è®°å½•å°†æ— æ³•æ¢å¤',
                            '',
                            'ç¡®å®šè¦ç»§ç»­å—ï¼Ÿ'
                        ],
                        confirmText: 'ç¡®è®¤æ¸…é™¤',
                        cancelText: 'å–æ¶ˆ',
                        buttonClass: 'modal-btn-danger',
                        onConfirm: () => {
                            // æ¸…é™¤æ‰€æœ‰æŠ•ç¥¨ç›¸å…³çš„localStorage
                            const keysToRemove = [];
                            for (let i = 0; i < localStorage.length; i++) {
                                const key = localStorage.key(i);
                                if (key && (key.startsWith('total_votes_') || key.startsWith('voted_candidate_'))) {
                                    keysToRemove.push(key);
                                }
                            }
                            keysToRemove.forEach(key => localStorage.removeItem(key));

                            // é‡ç½®çŠ¶æ€
                            this.totalVotedCount = 0;
                            this.votedCandidates = {};

                            // é‡æ–°åŠ è½½å€™é€‰äººæ•°æ®
                            this.loadCandidates();

                            // æ˜¾ç¤ºæˆåŠŸæç¤º
                            this.showSuccess('æŠ•ç¥¨è®°å½•å·²æ¸…é™¤ï¼ç°åœ¨æ‚¨å¯ä»¥é‡æ–°æŠ•ç¥¨äº†ã€‚');
                        }
                    });
                },

                async loadActivities() {
                    try {
                        const response = await axios.get('http://localhost:8082/api/activities');
                        this.activities = response.data.data || [];
                        // é»˜è®¤é€‰æ‹©ç¬¬ä¸€ä¸ªè¿›è¡Œä¸­çš„æ´»åŠ¨
                        const activeActivity = this.activities.find(a => a.status === 1);
                        if (activeActivity) {
                            this.selectedActivityId = activeActivity.id;
                            await this.loadCandidates();
                        }
                    } catch (error) {
                        console.error('åŠ è½½æ´»åŠ¨å¤±è´¥:', error);
                    }
                },

                async loadCandidates() {
                    if (!this.selectedActivityId) return;

                    try {
                        const response = await axios.get(`http://localhost:8082/api/activities/${this.selectedActivityId}/candidates`);
                        this.candidates = response.data.data || [];
                        console.log('åŠ è½½å€™é€‰äººæ•°æ®:', this.candidates);
                        this.candidates.forEach(c => {
                            console.log(`å€™é€‰äºº ${c.name} (ID: ${c.id}) çš„ç¥¨æ•°: ${c.votes}`);
                        });
                        this.totalVotes = this.candidates.reduce((sum, c) => sum + c.votes, 0);
                        console.log('æ€»ç¥¨æ•°:', this.totalVotes);

                        // åŠ è½½æ•´ä¸ªæ´»åŠ¨çš„å·²æŠ•æ€»ç¥¨æ•°
                        const totalVoteKey = 'total_votes_' + this.selectedActivityId;
                        this.totalVotedCount = parseInt(localStorage.getItem(totalVoteKey) || '0');

                        // åŠ è½½æ¯ä¸ªå€™é€‰äººçš„æŠ•ç¥¨çŠ¶æ€
                        this.candidates.forEach(c => {
                            const votedKey = 'voted_candidate_' + this.selectedActivityId + '_' + c.id;
                            this.votedCandidates[c.id] = localStorage.getItem(votedKey) === 'true';
                        });
                    } catch (error) {
                        this.message = 'åŠ è½½å€™é€‰äººå¤±è´¥: ' + (error.response?.data?.message || error.message);
                        this.messageType = 'error';
                    }
                },

                async vote(candidateId) {
                    const activity = this.activities.find(a => a.id === this.selectedActivityId);
                    const voteLimit = activity ? activity.voteLimit || 10 : 10;

                    console.log('=== å¼€å§‹æŠ•ç¥¨ ===');
                    console.log('å€™é€‰äººID:', candidateId);
                    console.log('æ´»åŠ¨ID:', this.selectedActivityId);
                    console.log('æ‰‹æœºå·:', this.loginForm.phone);
                    console.log('ç”¨æˆ·å:', this.loginForm.username);

                    // æ£€æŸ¥æ˜¯å¦å·²ç»æŠ•è¿‡è¿™ä¸ªå€™é€‰äºº
                    if (this.votedCandidates[candidateId]) {
                        this.showModal({
                            icon: 'âš ï¸',
                            title: 'é‡å¤æŠ•ç¥¨',
                            content: ['æ‚¨å·²ç»ä¸ºè¯¥å€™é€‰äººæŠ•è¿‡ç¥¨äº†', 'æ¯ä¸ªå€™é€‰äººé™æŠ• 1 ç¥¨'],
                            confirmText: 'æˆ‘çŸ¥é“äº†'
                        });
                        return;
                    }

                    // æ£€æŸ¥æ•´ä¸ªæ´»åŠ¨æ˜¯å¦å·²è¾¾åˆ°æŠ•ç¥¨é™åˆ¶
                    if (this.totalVotedCount >= voteLimit) {
                        this.showModal({
                            icon: 'ğŸš«',
                            title: 'æŠ•ç¥¨æ¬¡æ•°å·²è¾¾ä¸Šé™',
                            content: [
                                `æ‚¨å·²ç»æŠ•äº† ${this.totalVotedCount} ç¥¨`,
                                `æ¯äººæ¯æ´»åŠ¨é™æŠ• ${voteLimit} ç¥¨`,
                                '',
                                'å¦‚éœ€é‡æ–°æŠ•ç¥¨ï¼Œè¯·ç‚¹å‡»"æ¸…é™¤æŠ•ç¥¨è®°å½•"æŒ‰é’®'
                            ],
                            confirmText: 'æˆ‘çŸ¥é“äº†'
                        });
                        return;
                    }

                    this.voting = true;
                    this.message = '';
                    try {
                        console.log('å‘é€æŠ•ç¥¨è¯·æ±‚...');
                        const voteData = {
                            activityId: this.selectedActivityId,
                            candidateId: candidateId,
                            channel: 'WEB',
                            voterPhone: this.loginForm.phone || null,
                            voterName: this.loginForm.username || null
                        };
                        console.log('æŠ•ç¥¨æ•°æ®:', voteData);

                        const response = await axios.post('http://localhost:8082/api/votes', voteData);
                        console.log('æŠ•ç¥¨å“åº”:', response.data);

                        // è®°å½•è¯¥å€™é€‰äººå·²æŠ•ç¥¨
                        const votedKey = 'voted_candidate_' + this.selectedActivityId + '_' + candidateId;
                        this.votedCandidates[candidateId] = true;
                        localStorage.setItem(votedKey, 'true');

                        // æ›´æ–°æ•´ä¸ªæ´»åŠ¨çš„å·²æŠ•æ€»ç¥¨æ•°
                        const totalVoteKey = 'total_votes_' + this.selectedActivityId;
                        this.totalVotedCount++;
                        localStorage.setItem(totalVoteKey, this.totalVotedCount.toString());

                        // æ˜¾ç¤ºæˆåŠŸæç¤º
                        this.showSuccess(`æŠ•ç¥¨æˆåŠŸï¼æ‚¨å·²æŠ• ${this.totalVotedCount} ç¥¨ï¼ˆå…± ${voteLimit} ç¥¨ï¼‰`);

                        // åˆ·æ–°æ•°æ®
                        await this.loadCandidates();
                    } catch (error) {
                        console.error('æŠ•ç¥¨é”™è¯¯:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', error.response);
                        const errorMsg = error.response?.data?.message || error.message;

                        // åˆ¤æ–­æ˜¯å¦æ˜¯è¶…å‡ºæŠ•ç¥¨é™åˆ¶
                        if (errorMsg.includes('è¶…å‡ºæŠ•ç¥¨é™åˆ¶') || errorMsg.includes('è¶…é™') || errorMsg.includes('limit')) {
                            this.showModal({
                                icon: 'ğŸš«',
                                title: 'æŠ•ç¥¨æ¬¡æ•°å·²è¾¾ä¸Šé™',
                                content: [
                                    errorMsg,
                                    '',
                                    `æ‚¨å·²æŠ• ${this.totalVotedCount} ç¥¨ï¼ˆé™æŠ• ${voteLimit} ç¥¨ï¼‰`,
                                    '',
                                    'å¦‚éœ€é‡æ–°æŠ•ç¥¨ï¼Œè¯·ç‚¹å‡»"æ¸…é™¤æŠ•ç¥¨è®°å½•"æŒ‰é’®'
                                ],
                                confirmText: 'æˆ‘çŸ¥é“äº†'
                            });
                        } else {
                            this.showError('æŠ•ç¥¨å¤±è´¥ï¼š' + errorMsg);
                        }
                    }
                    this.voting = false;
                    console.log('=== æŠ•ç¥¨ç»“æŸ ===');
                },

                getAvatarUrl(avatar) {
                    if (!avatar) return '';
                    if (avatar.startsWith('http://') || avatar.startsWith('https://')) {
                        return avatar;
                    }
                    return 'http://localhost:8082' + avatar;
                },

                getVotePercentage(votes) {
                    if (this.totalVotes === 0) return 0;
                    return Math.round((votes / this.totalVotes) * 100);
                },

                truncateDescription(desc) {
                    if (!desc) return 'æš‚æ— æè¿°';
                    if (desc.length <= 30) return desc;
                    return desc.substring(0, 30) + '...';
                },

                // Modal Methods
                showModal(options) {
                    this.modal = {
                        show: true,
                        icon: options.icon || 'âœ…',
                        title: options.title || 'æç¤º',
                        content: Array.isArray(options.content) ? options.content : [options.content],
                        confirmText: options.confirmText || 'ç¡®å®š',
                        cancelText: options.cancelText || 'å–æ¶ˆ',
                        showCancel: options.showCancel || false,
                        buttonClass: options.buttonClass || 'modal-btn-primary',
                        onConfirm: options.onConfirm || (() => this.closeModal())
                    };
                },
                closeModal() {
                    this.modal.show = false;
                },
                showConfirm(options) {
                    this.showModal({
                        ...options,
                        showCancel: true
                    });
                },

                // Toast Methods
                showToast(options) {
                    // Clear previous timeout
                    if (this.toast.timeout) {
                        clearTimeout(this.toast.timeout);
                    }

                    this.toast = {
                        show: true,
                        icon: options.icon || 'âœ…',
                        message: options.message || 'æ“ä½œæˆåŠŸ',
                        type: options.type || 'toast-success',
                        timeout: setTimeout(() => {
                            this.toast.show = false;
                        }, options.duration || 3000)
                    };
                },
                showSuccess(message) {
                    this.showToast({
                        icon: 'âœ…',
                        message,
                        type: 'toast-success'
                    });
                },
                showError(message) {
                    this.showToast({
                        icon: 'âŒ',
                        message,
                        type: 'toast-error'
                    });
                },
                showWarning(message) {
                    this.showToast({
                        icon: 'âš ï¸',
                        message,
                        type: 'toast-warning'
                    });
                },
                showInfo(message) {
                    this.showToast({
                        icon: 'â„¹ï¸',
                        message,
                        type: 'toast-info'
                    });
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
