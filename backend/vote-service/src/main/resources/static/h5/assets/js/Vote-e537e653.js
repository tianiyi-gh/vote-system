import{d as a,r as e,a as t,l,o as s,c as i,b as n,w as o,F as c,g as d,t as u,f as r,m as v,u as p,h as m,i as h,k as g,j as y,n as f,e as k}from"./index-bee774cb.js";import{d as w}from"./dayjs.min-5064d808.js";import{s as V,_}from"./_plugin-vue_export-helper-2404cc8e.js";const b={class:"vote-page"},C={key:0,class:"loading-wrapper"},x={class:"activity-header"},I={class:"activity-info"},T={class:"activity-meta"},N={class:"time-info"},j={class:"search-section"},F={class:"container"},D=["onClick"],U={class:"candidate-name"},K={class:"candidate-no"},M={class:"candidate-desc"},P={class:"candidate-stats"},S={class:"vote-count"},z={key:0,class:"empty-state"},L={class:"empty-text"},$={key:2,class:"error-state"},H={key:3,class:"vote-button"},q={class:"vote-dialog-content"},E={class:"selected-candidate"},O={class:"candidate-name"},R={class:"candidate-no"},A=_(a({__name:"Vote",setup(a){const _=v();p();const A=e(!0),B=e(!1),G=e(!1),J=e(!1),Q=e(!1),W=e(""),X=e("/captcha.jpg"),Y=e(),Z=e([]),aa=e(),ea=t({captcha:"",captchaKey:""}),ta=l(()=>W.value?Z.value.filter(a=>a.name.includes(W.value)||a.candidateNo.includes(W.value)):Z.value),la=async()=>{try{const a=_.params.serviceId;Y.value=await ua(a),Y.value&&2!==Y.value.status&&(Z.value=await ra(a))}catch(a){V("加载失败")}finally{A.value=!1}},sa=async()=>{A.value=!1,J.value=!0},ia=async()=>{await la(),G.value=!1},na=()=>{},oa=()=>{aa.value?(ca(),Q.value=!0):V("请先选择候选人")},ca=()=>{ea.captchaKey=Date.now().toString(),X.value=`/api/captcha?key=${ea.captchaKey}`},da=async()=>{if(aa.value&&Y.value)if(ea.captcha){B.value=!0;try{Y.value.id,aa.value.id,await va(),ea.captcha,ea.captchaKey;await new Promise(a=>setTimeout(a,1e3)),V("投票成功！"),aa.value.totalVotes+=1,Q.value=!1,ea.captcha=""}catch(a){V(a.message||"投票失败")}finally{B.value=!1}}else V("请输入验证码")},ua=async a=>(await new Promise(a=>setTimeout(a,500)),{id:1,serviceId:a,title:"最美乡村评选",subtitle:"寻找我们身边的美丽乡村",coverImage:"https://via.placeholder.com/400x200",region:"山东",status:1,startTime:"2025-01-01 00:00:00",endTime:"2025-12-31 23:59:59",totalVotes:12345,candidateCount:10}),ra=async a=>(await new Promise(a=>setTimeout(a,500)),[{id:1,activityId:1,serviceId:a,candidateNo:"001",name:"张村",groupName:"第一组",description:"美丽的乡村，风景如画",photo:"https://via.placeholder.com/80",totalVotes:1234,ranking:1,status:0,createTime:"2024-12-01 10:00:00"},{id:2,activityId:1,serviceId:a,candidateNo:"002",name:"李村",groupName:"第一组",description:"历史悠久，文化底蕴深厚",photo:"https://via.placeholder.com/80",totalVotes:987,ranking:2,status:0,createTime:"2024-12-02 11:00:00"},{id:3,activityId:1,serviceId:a,candidateNo:"003",name:"王村",groupName:"第二组",description:"山水秀美，人杰地灵",photo:"https://via.placeholder.com/80",totalVotes:654,ranking:3,status:0,createTime:"2024-12-03 12:00:00"}]),va=async()=>"127.0.0.1",pa=a=>{if(!Z.value.length)return 0;const e=Math.max(...Z.value.map(a=>a.totalVotes));return Math.round(a/e*100)},ma=a=>w(a).format("MM-DD HH:mm"),ha=a=>({0:"未开始",1:"进行中",2:"已结束"}[a]||"未知");return s(()=>{la()}),(a,e)=>{var t,l;const s=m("van-nav-bar"),v=m("van-loading"),p=m("van-image"),w=m("van-tag"),V=m("van-search"),_=m("van-progress"),Z=m("van-card"),la=m("van-list"),ua=m("van-pull-refresh"),ra=m("van-button"),va=m("van-field"),ga=m("van-form"),ya=m("van-dialog");return h(),i("div",b,[n(s,{title:(null==(t=Y.value)?void 0:t.title)||"投票","left-arrow":"",onClickLeft:e[0]||(e[0]=e=>a.$router.back()),fixed:""},null,8,["title"]),A.value?(h(),i("div",C,[n(v,{size:"24px",vertical:""},{default:o(()=>[...e[7]||(e[7]=[g("加载中...",-1)])]),_:1})])):Y.value?(h(),i(c,{key:1},[d("div",x,[n(p,{src:Y.value.coverImage||"/default-activity.png",width:"100%",height:"200",fit:"cover"},null,8,["src"]),d("div",I,[d("h2",null,u(Y.value.title),1),d("p",null,u(Y.value.subtitle),1),d("div",T,[n(w,{type:(fa=Y.value.status,{0:"warning",1:"success",2:"danger"}[fa]||"default")},{default:o(()=>[g(u(ha(Y.value.status)),1)]),_:1},8,["type"]),d("span",N,u(ma(Y.value.startTime))+" - "+u(ma(Y.value.endTime)),1)])])]),d("div",j,[n(V,{modelValue:W.value,"onUpdate:modelValue":e[1]||(e[1]=a=>W.value=a),placeholder:"搜索候选人...",onSearch:na},null,8,["modelValue"])]),d("div",F,[n(ua,{modelValue:G.value,"onUpdate:modelValue":e[3]||(e[3]=a=>G.value=a),onRefresh:ia},{default:o(()=>[n(la,{loading:A.value,"onUpdate:loading":e[2]||(e[2]=a=>A.value=a),finished:J.value,"finished-text":"没有更多了",onLoad:sa},{default:o(()=>[(h(!0),i(c,null,y(ta.value,a=>{var e;return h(),i("div",{key:a.id,class:f(["candidate-card",{selected:(null==(e=aa.value)?void 0:e.id)===a.id}]),onClick:e=>(a=>{aa.value=a})(a)},[n(Z,null,{thumb:o(()=>[n(p,{src:a.photo||"/default-avatar.png",width:"80",height:"80",fit:"cover",round:""},null,8,["src"])]),title:o(()=>{return[d("div",U,[g(u(a.name)+" ",1),a.ranking<=3?(h(),k(w,{key:0,type:(e=a.ranking,{1:"warning",2:"success",3:"info"}[e]||""),size:"small"},{default:o(()=>[g(" TOP"+u(a.ranking),1)]),_:2},1032,["type"])):r("",!0)]),d("div",K,"编号: "+u(a.candidateNo),1)];var e}),desc:o(()=>{return[d("div",M,u(a.description||"暂无简介"),1),d("div",P,[d("div",S,u(a.totalVotes.toLocaleString())+" 票",1),n(_,{percentage:pa(a.totalVotes),color:(e=a.ranking,{1:"#FFD700",2:"#C0C0C0",3:"#CD7F32"}[e]||"#409EFF"),"stroke-width":"4"},null,8,["percentage","color"])])];var e}),_:2},1024)],10,D)}),128))]),_:1},8,["loading","finished"])]),_:1},8,["modelValue"]),A.value||0!==ta.value.length?r("",!0):(h(),i("div",z,[n(p,{src:"/empty-candidate.png",class:"empty-image"}),d("div",L,u(W.value?"未找到相关候选人":"暂无候选人"),1)]))])],64)):(h(),i("div",$,[n(p,{src:"/error-image.png",class:"error-image"}),e[9]||(e[9]=d("div",{class:"error-text"},"活动不存在或已结束",-1)),n(ra,{type:"primary",onClick:e[4]||(e[4]=e=>a.$router.push("/"))},{default:o(()=>[...e[8]||(e[8]=[g("返回首页",-1)])]),_:1})])),aa.value&&1===(null==(l=Y.value)?void 0:l.status)?(h(),i("div",H,[n(ra,{type:"danger",size:"large",onClick:oa,loading:B.value},{default:o(()=>[g(" 为 "+u(aa.value.name)+" 投票 ",1)]),_:1},8,["loading"])])):r("",!0),n(ya,{show:Q.value,"onUpdate:show":e[6]||(e[6]=a=>Q.value=a),title:"确认投票","show-cancel-button":"",onConfirm:da},{default:o(()=>{var a,t,l;return[d("div",q,[d("div",E,[n(p,{src:(null==(a=aa.value)?void 0:a.photo)||"/default-avatar.png",width:"60",height:"60",fit:"cover",round:""},null,8,["src"]),d("div",null,[d("div",O,u(null==(t=aa.value)?void 0:t.name),1),d("div",R,"编号: "+u(null==(l=aa.value)?void 0:l.candidateNo),1)])]),n(ga,{onSubmit:da},{default:o(()=>[n(va,{modelValue:ea.captcha,"onUpdate:modelValue":e[5]||(e[5]=a=>ea.captcha=a),name:"captcha",label:"验证码",placeholder:"请输入验证码",rules:[{required:!0,message:"请输入验证码"}]},{button:o(()=>[n(p,{src:X.value,onClick:ca,style:{height:"30px",cursor:"pointer"}},null,8,["src"])]),_:1},8,["modelValue"])]),_:1})])]}),_:1},8,["show"])]);var fa}}}),[["__scopeId","data-v-067696d6"]]);export{A as default};
