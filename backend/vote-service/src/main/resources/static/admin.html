<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>æŠ•ç¥¨ç®¡ç†åå°</title>
    <script src="https://unpkg.com/vue@3/dist/vue.global.js"></script>
    <script src="https://unpkg.com/axios/dist/axios.min.js"></script>
    <script src="https://unpkg.com/echarts@5.4.3/dist/echarts.min.js"></script>
    <style>
        * { margin: 0; padding: 0; box-sizing: border-box; }
        body { font-family: 'Segoe UI', Arial, sans-serif; background: #f5f7fa; }
        .container { max-width: 1600px; margin: 0 auto; padding: 20px; }

        /* Header */
        .header {
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            color: white;
            padding: 20px 30px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            box-shadow: 0 2px 10px rgba(0,0,0,0.1);
        }
        .header h1 { margin: 0; font-size: 24px; }

        /* Login */
        .login-section {
            background: white;
            padding: 40px;
            border-radius: 15px;
            max-width: 400px;
            margin: 100px auto;
            box-shadow: 0 4px 20px rgba(0,0,0,0.1);
        }
        .login-section h2 { text-align: center; margin-bottom: 30px; color: #667eea; }

        /* Tabs */
        .tabs { display: flex; gap: 5px; margin-bottom: 20px; background: white; padding: 5px; border-radius: 10px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .tab { flex: 1; padding: 12px; border: none; background: transparent; cursor: pointer; border-radius: 8px; font-weight: 500; color: #666; transition: all 0.3s; }
        .tab:hover { background: #f0f0f0; }
        .tab.active { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; }

        /* Cards */
        .card { background: white; padding: 25px; border-radius: 12px; margin-bottom: 20px; box-shadow: 0 2px 10px rgba(0,0,0,0.05); }
        .card h2 { margin-bottom: 20px; color: #1e3c72; font-size: 20px; border-bottom: 2px solid #667eea; padding-bottom: 10px; }

        /* Stats */
        .stats { display: grid; grid-template-columns: repeat(auto-fit, minmax(220px, 1fr)); gap: 20px; margin-bottom: 20px; }
        .stat-card { background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; padding: 25px; border-radius: 12px; text-align: center; box-shadow: 0 4px 15px rgba(102, 126, 234, 0.3); }
        .stat-value { font-size: 36px; font-weight: bold; margin-bottom: 5px; }
        .stat-label { font-size: 14px; opacity: 0.9; }

        /* Tables */
        table { width: 100%; border-collapse: collapse; }
        th, td { padding: 15px; text-align: left; border-bottom: 1px solid #eee; }
        th { background: #f8f9fa; font-weight: 600; color: #1e3c72; }
        tr:hover { background: #f8f9fa; }

        /* Forms */
        .form-group { margin-bottom: 15px; }
        .form-group label { display: block; margin-bottom: 8px; font-weight: 500; color: #333; }
        .form-group input, .form-group select, .form-group textarea {
            width: 100%; padding: 12px; border: 1px solid #ddd; border-radius: 8px; font-size: 14px; transition: border-color 0.3s;
        }
        .form-group input:focus, .form-group select:focus, .form-group textarea:focus {
            outline: none; border-color: #667eea;
        }

        /* Buttons */
        .btn { padding: 10px 25px; background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white; border: none; border-radius: 8px; cursor: pointer; font-size: 14px; transition: all 0.3s; }
        .btn:hover { transform: translateY(-2px); box-shadow: 0 4px 12px rgba(102, 126, 234, 0.4); }
        .btn:disabled { background: #ccc; cursor: not-allowed; transform: none; box-shadow: none; }
        .btn-danger { background: linear-gradient(135deg, #f093fb 0%, #f5576c 100%); }
        .btn-success { background: linear-gradient(135deg, #4facfe 0%, #00f2fe 100%); }
        .btn-sm { padding: 5px 12px; font-size: 12px; }
        .btn-group { display: flex; gap: 10px; }

        /* Alerts */
        .alert { padding: 12px; border-radius: 8px; margin-bottom: 15px; }
        .alert.success { background: #d4edda; color: #155724; border-left: 4px solid #28a745; }
        .alert.error { background: #f8d7da; color: #721c24; border-left: 4px solid #dc3545; }

        /* Modal */
        .modal-overlay { position: fixed; top: 0; left: 0; right: 0; bottom: 0; background: rgba(0,0,0,0.5); display: flex; align-items: center; justify-content: center; z-index: 1000; }
        .modal { background: white; padding: 30px; border-radius: 15px; max-width: 600px; width: 90%; max-height: 90vh; overflow-y: auto; box-shadow: 0 10px 40px rgba(0,0,0,0.2); }

        /* Rate Limit Settings */
        .rate-limit-item { background: #f8f9fa; padding: 15px; border-radius: 8px; margin-bottom: 15px; }
        .rate-limit-item h4 { margin-bottom: 10px; color: #1e3c72; }
        .rate-limit-setting { display: flex; gap: 15px; align-items: center; }
        .rate-limit-setting label { min-width: 150px; font-weight: 500; }

        /* Image Upload */
        .image-upload-section { text-align: center; margin-bottom: 20px; }
        .image-preview {
            width: 150px; height: 150px; margin: 0 auto; border: 2px dashed #667eea;
            border-radius: 10px; display: flex; align-items: center; justify-content: center;
            overflow: hidden; cursor: pointer; transition: all 0.3s; background: white;
        }
        .image-preview:hover { border-color: #764ba2; box-shadow: 0 4px 12px rgba(102, 126, 234, 0.3); }
        .image-preview img { width: 100%; height: 100%; object-fit: cover; }
        .image-placeholder { text-align: center; color: #667eea; }
        .upload-icon { font-size: 40px; display: block; margin-bottom: 10px; }
        .image-actions { text-align: center; margin-top: 10px; }

        /* Progress Bar */
        .progress-container { margin: 15px 0; text-align: center; }
        .progress-bar { width: 100%; height: 8px; background: #e9ecef; border-radius: 4px; overflow: hidden; }
        .progress-fill { height: 100%; background: linear-gradient(90deg, #667eea 0%, #764ba2 100%); transition: width 0.3s; }

        /* Status badges */
        .status-badge { padding: 4px 12px; border-radius: 12px; font-size: 12px; font-weight: 500; }
        .status-1 { background: #d4edda; color: #155724; }
        .status-2 { background: #f8d7da; color: #721c24; }
        .status-3 { background: #fff3cd; color: #856404; }

        /* Responsive */
        @media (max-width: 768px) {
            .tabs { flex-direction: column; }
            .stats { grid-template-columns: 1fr; }
        }
    </style>
</head>
<body>
    <div id="app">
        <!-- Login Section -->
        <div v-if="!token" class="login-section">
            <h2>ğŸ” ç®¡ç†å‘˜ç™»å½•</h2>
            <div v-if="message" :class="['alert', messageType]">{{ message }}</div>
            <div class="form-group">
                <label>ç”¨æˆ·å</label>
                <input v-model="loginForm.username" type="text" placeholder="è¯·è¾“å…¥ç”¨æˆ·å">
            </div>
            <div class="form-group">
                <label>å¯†ç </label>
                <input v-model="loginForm.password" type="password" placeholder="è¯·è¾“å…¥å¯†ç ">
            </div>
            <button class="btn" @click="login" :disabled="loading" style="width: 100%; padding: 12px;">
                {{ loading ? 'ç™»å½•ä¸­...' : 'ç™»å½•' }}
            </button>
        </div>

        <!-- Main Content -->
        <div v-else>
            <div class="header">
                <h1>ğŸ¯ æŠ•ç¥¨ç®¡ç†åå°</h1>
                <button class="btn btn-danger btn-sm" @click="logout">é€€å‡ºç™»å½•</button>
            </div>

            <div class="container">
                <!-- Stats Cards -->
                <div class="stats">
                    <div class="stat-card">
                        <div class="stat-value">{{ overviewStats.totalActivities }}</div>
                        <div class="stat-label">æ´»åŠ¨æ€»æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ overviewStats.totalCandidates }}</div>
                        <div class="stat-label">å€™é€‰äººæ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ overviewStats.totalVotes }}</div>
                        <div class="stat-label">æ€»ç¥¨æ•°</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-value">{{ overviewStats.activeActivities }}</div>
                        <div class="stat-label">è¿›è¡Œä¸­æ´»åŠ¨</div>
                    </div>
                </div>

                <!-- Tabs -->
                <div class="tabs">
                    <button :class="['tab', {active: activeTab === 'activities'}]" @click="activeTab = 'activities'">
                        ğŸ“‹ æ´»åŠ¨ç®¡ç†
                    </button>
                    <button :class="['tab', {active: activeTab === 'candidates'}]" @click="activeTab = 'candidates'">
                        ğŸ‘¥ å€™é€‰äººç®¡ç†
                    </button>
                    <button :class="['tab', {active: activeTab === 'statistics'}]" @click="activeTab = 'statistics'">
                        ğŸ“Š ç»Ÿè®¡åˆ†æ
                    </button>
                    <button :class="['tab', {active: activeTab === 'settings'}]" @click="activeTab = 'settings'">
                        âš™ï¸ é˜²åˆ·ç¥¨è®¾ç½®
                    </button>
                </div>

                <!-- Activities Tab -->
                <div v-show="activeTab === 'activities'" class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>ğŸ“‹ æ´»åŠ¨ç®¡ç†</h2>
                        <button class="btn btn-success" @click="showActivityModal = true; activityForm = {status: 1, voteLimit: 1}">+ æ–°å»ºæ´»åŠ¨</button>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>æ ‡é¢˜</th>
                                <th>å¼€å§‹æ—¶é—´</th>
                                <th>ç»“æŸæ—¶é—´</th>
                                <th>çŠ¶æ€</th>
                                <th>å€™é€‰äººæ•°</th>
                                <th>æ€»ç¥¨æ•°</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="activity in activities" :key="activity.id">
                                <td>{{ activity.id }}</td>
                                <td>{{ activity.title }}</td>
                                <td>{{ formatDate(activity.startTime) }}</td>
                                <td>{{ formatDate(activity.endTime) }}</td>
                                <td><span :class="['status-badge', 'status-' + activity.id]">{{ getStatusText(activity.status) }}</span></td>
                                <td>{{ activity.candidateCount }}</td>
                                <td>{{ activity.totalVotes }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm" @click="editActivity(activity)">ç¼–è¾‘</button>
                                        <button class="btn btn-danger btn-sm" @click="deleteActivity(activity.id)">åˆ é™¤</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Candidates Tab -->
                <div v-show="activeTab === 'candidates'" class="card">
                    <div style="display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px;">
                        <h2>ğŸ‘¥ å€™é€‰äººç®¡ç†</h2>
                        <div style="display: flex; gap: 10px;">
                            <select v-model="selectedActivityId" @change="loadCandidates" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                                <option value="">é€‰æ‹©æ´»åŠ¨</option>
                                <option v-for="activity in activities" :key="activity.id" :value="activity.id">
                                    {{ activity.title }}
                                </option>
                            </select>
                            <button class="btn btn-success" @click="openAddCandidateModal" :disabled="!selectedActivityId">
                                + æ–°å»ºå€™é€‰äºº
                            </button>
                        </div>
                    </div>
                    <table>
                        <thead>
                            <tr>
                                <th>ID</th>
                                <th>å§“å</th>
                                <th>æè¿°</th>
                                <th>ç¥¨æ•°</th>
                                <th>æ’åº</th>
                                <th>æ“ä½œ</th>
                            </tr>
                        </thead>
                        <tbody>
                            <tr v-for="candidate in candidates" :key="candidate.id">
                                <td>{{ candidate.id }}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 10px;">
                                        <img v-if="candidate.avatar" :src="getAvatarUrl(candidate.avatar)" alt="å¤´åƒ" style="width: 40px; height: 40px; border-radius: 50%; object-fit: cover;">
                                        <span>{{ candidate.name }}</span>
                                    </div>
                                </td>
                                <td>{{ candidate.description || '-' }}</td>
                                <td>
                                    <div style="display: flex; align-items: center; gap: 5px;">
                                        <input type="number" v-model.number="candidate.voteAdjust" style="width: 60px; padding: 5px;" placeholder="+/-">
                                        <button class="btn btn-sm" @click="adjustVotes(candidate.id, candidate.voteAdjust || 0)">è°ƒæ•´</button>
                                        {{ candidate.votes }}
                                    </div>
                                </td>
                                <td>{{ candidate.orderNum }}</td>
                                <td>
                                    <div class="btn-group">
                                        <button class="btn btn-sm" @click="editCandidate(candidate)">ç¼–è¾‘</button>
                                        <button class="btn btn-danger btn-sm" @click="deleteCandidate(candidate.id)">åˆ é™¤</button>
                                    </div>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>

                <!-- Statistics Tab -->
                <div v-show="activeTab === 'statistics'" class="card">
                    <h2>ğŸ“Š ç»Ÿè®¡åˆ†æ</h2>
                    <div style="margin-bottom: 20px; display: flex; gap: 15px; align-items: center;">
                        <label>é€‰æ‹©æ´»åŠ¨ï¼š</label>
                        <select v-model="statActivityId" @change="loadStatistics" style="padding: 8px; border-radius: 5px; border: 1px solid #ddd;">
                            <option value="">é€‰æ‹©æ´»åŠ¨</option>
                            <option v-for="activity in activities" :key="activity.id" :value="activity.id">
                                {{ activity.title }}
                            </option>
                        </select>
                        <button class="btn btn-success btn-sm" @click="exportReport" :disabled="!statActivityId">ğŸ“¥ å¯¼å‡ºæŠ¥è¡¨</button>
                    </div>

                    <div v-if="activityStats" style="margin-top: 20px;">
                        <h3>æ´»åŠ¨æ¦‚è§ˆ</h3>
                        <div class="stats" style="margin-top: 15px;">
                            <div class="stat-card">
                                <div class="stat-value">{{ activityStats.totalVotes }}</div>
                                <div class="stat-label">æ€»ç¥¨æ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ activityStats.uniqueVoters }}</div>
                                <div class="stat-label">ç‹¬ç«‹æŠ•ç¥¨äººæ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ activityStats.candidates.length }}</div>
                                <div class="stat-label">å€™é€‰äººæ•°</div>
                            </div>
                            <div class="stat-card">
                                <div class="stat-value">{{ activityStats.dailyVotes }}</div>
                                <div class="stat-label">ä»Šæ—¥ç¥¨æ•°</div>
                            </div>
                        </div>

                        <!-- æŠ•ç¥¨è¶‹åŠ¿å›¾è¡¨ -->
                        <h3 style="margin-top: 30px;">æŠ•ç¥¨è¶‹åŠ¿ï¼ˆè¿‘7å¤©ï¼‰</h3>
                        <div id="voteTrendChart" style="width: 100%; height: 400px; margin-top: 15px;"></div>

                        <!-- å€™é€‰äººå¾—ç¥¨åˆ†å¸ƒ -->
                        <h3 style="margin-top: 30px;">å€™é€‰äººå¾—ç¥¨åˆ†å¸ƒ</h3>
                        <div id="voteDistributionChart" style="width: 100%; height: 400px; margin-top: 15px;"></div>

                        <!-- å°æ—¶å‚ä¸åº¦ -->
                        <h3 style="margin-top: 30px;">ä»Šæ—¥æ—¶æ®µå‚ä¸åº¦</h3>
                        <div id="hourlyParticipationChart" style="width: 100%; height: 400px; margin-top: 15px;"></div>

                        <h3 style="margin-top: 30px;">å€™é€‰äººè¯¦ç»†æ’å</h3>
                        <table style="margin-top: 15px;">
                            <thead>
                                <tr>
                                    <th>æ’å</th>
                                    <th>å§“å</th>
                                    <th>ç¥¨æ•°</th>
                                    <th>å æ¯”</th>
                                    <th>è¶‹åŠ¿</th>
                                </tr>
                            </thead>
                            <tbody>
                                <tr v-for="(candidate, index) in sortedCandidates" :key="candidate.id">
                                    <td>
                                        <span v-if="index === 0">ğŸ¥‡</span>
                                        <span v-else-if="index === 1">ğŸ¥ˆ</span>
                                        <span v-else-if="index === 2">ğŸ¥‰</span>
                                        <span v-else>{{ index + 1 }}</span>
                                    </td>
                                    <td>{{ candidate.name }}</td>
                                    <td>{{ candidate.votes }}</td>
                                    <td>{{ ((candidate.votes / totalStatVotes * 100) || 0).toFixed(2) }}%</td>
                                    <td>
                                        <span v-if="index === 0" style="color: #28a745;">ğŸ“ˆ é¢†å…ˆ</span>
                                        <span v-else-if="index === sortedCandidates.length - 1" style="color: #dc3545;">ğŸ“‰ æš‚å±…æœ«ä½</span>
                                        <span v-else style="color: #667eea;">â¡ï¸ è¿½èµ¶ä¸­</span>
                                    </td>
                                </tr>
                            </tbody>
                        </table>
                    </div>
                </div>

                <!-- Settings Tab (Rate Limit) -->
                <div v-show="activeTab === 'settings'" class="card">
                    <h2>âš™ï¸ é˜²åˆ·ç¥¨è®¾ç½®</h2>

                    <div class="rate-limit-item">
                        <h4>æŠ•ç¥¨é™åˆ¶</h4>
                        <div class="rate-limit-setting">
                            <label>IPé™åˆ¶ï¼ˆæ¯å°æ—¶æœ€å¤šæŠ•ç¥¨æ•°ï¼‰ï¼š</label>
                            <input type="number" v-model.number="rateLimit.voteIpLimit" min="1" max="10" style="width: 100px;">
                            <span style="color: #666;">åŒä¸€IPåœ¨1å°æ—¶å†…æœ€å¤šèƒ½æŠ•å¤šå°‘ç¥¨</span>
                        </div>
                    </div>

                    <div class="rate-limit-item">
                        <h4>é¢‘ç‡é™åˆ¶</h4>
                        <div class="rate-limit-setting">
                            <label>è¯·æ±‚é¢‘ç‡é™åˆ¶ï¼ˆæ¯åˆ†é’Ÿï¼‰ï¼š</label>
                            <input type="number" v-model.number="rateLimit.rateLimitCount" min="5" max="100" style="width: 100px;">
                            <span style="color: #666;">æ¯ä¸ªIPæ¯åˆ†é’Ÿæœ€å¤šè¯·æ±‚æ¬¡æ•°</span>
                        </div>
                    </div>

                    <div class="rate-limit-item">
                        <h4>éªŒè¯ç è®¾ç½®</h4>
                        <div class="rate-limit-setting">
                            <label>å¯ç”¨éªŒè¯ç ï¼š</label>
                            <input type="checkbox" v-model="rateLimit.enableCaptcha">
                            <span style="color: #666;">æŠ•ç¥¨å‰éœ€è¦éªŒè¯ç ï¼ˆéœ€åç«¯å®ç°ï¼‰</span>
                        </div>
                    </div>

                    <div class="rate-limit-item">
                        <h4>ç”¨æˆ·é™åˆ¶</h4>
                        <div class="rate-limit-setting">
                            <label>æ¯äººæŠ•ç¥¨é™åˆ¶ï¼š</label>
                            <input type="number" v-model.number="rateLimit.userVoteLimit" min="1" max="10" style="width: 100px;">
                            <span style="color: #666;">æ¯ä¸ªç”¨æˆ·æœ€å¤šèƒ½æŠ•å¤šå°‘ç¥¨</span>
                        </div>
                    </div>

                    <button class="btn btn-success" @click="saveRateLimitSettings" style="margin-top: 20px;">ğŸ’¾ ä¿å­˜è®¾ç½®</button>
                </div>
            </div>
        </div>

        <!-- Activity Modal -->
        <div v-if="showActivityModal" class="modal-overlay">
            <div class="modal">
                <h2>{{ activityForm.id ? 'ç¼–è¾‘æ´»åŠ¨' : 'æ–°å»ºæ´»åŠ¨' }}</h2>
                <div class="form-group">
                    <label>æ´»åŠ¨æ ‡é¢˜</label>
                    <input v-model="activityForm.title" type="text" placeholder="è¯·è¾“å…¥æ´»åŠ¨æ ‡é¢˜">
                </div>
                <div class="form-group">
                    <label>æ´»åŠ¨æè¿°</label>
                    <textarea v-model="activityForm.description" rows="3" placeholder="è¯·è¾“å…¥æ´»åŠ¨æè¿°"></textarea>
                </div>
                <div class="form-group">
                    <label>å¼€å§‹æ—¶é—´</label>
                    <input v-model="activityForm.startTime" type="datetime-local">
                </div>
                <div class="form-group">
                    <label>ç»“æŸæ—¶é—´</label>
                    <input v-model="activityForm.endTime" type="datetime-local">
                </div>
                <div class="form-group">
                    <label>æ¯äººæŠ•ç¥¨é™åˆ¶</label>
                    <input v-model.number="activityForm.voteLimit" type="number" min="1" max="10">
                </div>
                <div class="form-group">
                    <label>çŠ¶æ€</label>
                    <select v-model.number="activityForm.status">
                        <option :value="1">è¿›è¡Œä¸­</option>
                        <option :value="2">å·²ç»“æŸ</option>
                        <option :value="3">å·²å–æ¶ˆ</option>
                    </select>
                </div>
                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn" @click="saveActivity">ä¿å­˜</button>
                    <button class="btn btn-danger" @click="showActivityModal = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>

        <!-- Candidate Modal -->
        <div v-if="showCandidateModal" class="modal-overlay">
            <div class="modal">
                <h2>{{ candidateForm.id ? 'ç¼–è¾‘å€™é€‰äºº' : 'æ–°å»ºå€™é€‰äºº' }}</h2>

                <!-- Image Upload Section -->
                <div class="image-upload-section">
                    <div class="image-preview" @click="triggerFileInput">
                        <img v-if="candidateForm.avatarPreview" :src="candidateForm.avatarPreview" alt="é¢„è§ˆ">
                        <div v-else class="image-placeholder">
                            <span class="upload-icon">ğŸ“·</span>
                            <span>ç‚¹å‡»ä¸Šä¼ å›¾ç‰‡</span>
                        </div>
                        <input type="file" ref="fileInput" @change="handleImageUpload" accept="image/*" style="display: none;">
                    </div>
                    <div v-if="candidateForm.avatarPreview" class="image-actions">
                        <button class="btn btn-danger btn-sm" @click="removeImage">åˆ é™¤å›¾ç‰‡</button>
                    </div>
                </div>

                <div class="form-group">
                    <label>å§“å *</label>
                    <input v-model="candidateForm.name" type="text" placeholder="è¯·è¾“å…¥å€™é€‰äººå§“å">
                </div>
                <div class="form-group">
                    <label>æè¿°</label>
                    <textarea v-model="candidateForm.description" rows="3"
                              placeholder="è¯·è¾“å…¥å€™é€‰äººæè¿°ï¼ˆæœ€å¤š30å­—ï¼‰"
                              maxlength="30"
                              @input="limitDescriptionLength"></textarea>
                    <div style="text-align: right; color: #999; font-size: 12px; margin-top: 5px;">
                        {{ (candidateForm.description || '').length }}/30
                    </div>
                </div>
                <div class="form-group">
                    <label>æ’åºå·</label>
                    <input v-model.number="candidateForm.orderNum" type="number" min="0" placeholder="æ•°å€¼è¶Šå°æ’åºè¶Šé å‰">
                </div>

                <!-- Progress Bar -->
                <div v-if="uploading" class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" :style="{width: uploadProgress + '%'}"></div>
                    </div>
                    <span>ä¸Šä¼ ä¸­... {{ uploadProgress }}%</span>
                </div>

                <div class="btn-group" style="margin-top: 20px;">
                    <button class="btn" @click="saveCandidate" :disabled="uploading || !candidateForm.name">ä¿å­˜</button>
                    <button class="btn btn-danger" @click="showCandidateModal = false">å–æ¶ˆ</button>
                </div>
            </div>
        </div>
    </div>

    <script>
        const { createApp } = Vue;

        createApp({
            data() {
                return {
                    token: localStorage.getItem('admin_token'),
                    loginForm: { username: '', password: '' },
                    loading: false,
                    message: '',
                    messageType: '',

                    activeTab: 'activities',

                    // Activities
                    activities: [],
                    showActivityModal: false,
                    activityForm: {},

                    // Candidates
                    selectedActivityId: null,
                    candidates: [],
                    showCandidateModal: false,
                    candidateForm: {},

                    // Image Upload
                    uploading: false,
                    uploadProgress: 0,

                    // Statistics
                    statActivityId: 1,
                    activityStats: null,
                    voteTrends: [],
                    hourlyParticipation: [],

                    // Rate Limit Settings
                    rateLimit: {
                        voteIpLimit: 1,
                        rateLimitCount: 10,
                        enableCaptcha: false,
                        userVoteLimit: 1
                    }
                }
            },
            computed: {
                sortedCandidates() {
                    if (!this.activityStats) return [];
                    return [...this.activityStats.candidates].sort((a, b) => b.votes - a.votes);
                },
                totalStatVotes() {
                    if (!this.activityStats) return 0;
                    return this.activityStats.candidates.reduce((sum, c) => sum + c.votes, 0);
                },
                overviewStats() {
                    return {
                        totalActivities: this.activities.length,
                        activeActivities: this.activities.filter(a => a.status === 1).length,
                        totalCandidates: this.candidates.length,
                        totalVotes: this.activities.reduce((sum, a) => sum + (a.totalVotes || 0), 0)
                    };
                }
            },
            mounted() {
                if (this.token) {
                    this.loadActivities();
                    this.loadRateLimitSettings();
                }
                // åˆå§‹åŒ–å€™é€‰äººè¡¨å•
                this.resetCandidateForm();
            },
            methods: {
                async login() {
                    this.loading = true;
                    this.message = '';
                    try {
                        const response = await axios.post('http://localhost:8084/api/auth/login', {
                            username: this.loginForm.username,
                            password: this.loginForm.password
                        });
                        this.token = response.data.token;
                        localStorage.setItem('admin_token', this.token);
                        this.message = 'ç™»å½•æˆåŠŸ';
                        this.messageType = 'success';
                        this.loadActivities();
                        this.loadRateLimitSettings();
                    } catch (error) {
                        this.message = 'ç™»å½•å¤±è´¥: ' + (error.response?.data?.message || error.message);
                        this.messageType = 'error';
                    }
                    this.loading = false;
                },

                logout() {
                    localStorage.removeItem('admin_token');
                    this.token = null;
                    this.activeTab = 'activities';
                },

                // Activities
                async loadActivities() {
                    try {
                        const response = await axios.get('http://localhost:8082/api/activities');
                        this.activities = response.data.data || [];
                    } catch (error) {
                        console.error('åŠ è½½æ´»åŠ¨å¤±è´¥:', error);
                    }
                },

                editActivity(activity) {
                    this.activityForm = { ...activity };
                    this.showActivityModal = true;
                },

                async saveActivity() {
                    try {
                        if (this.activityForm.id) {
                            await axios.put(`http://localhost:8082/api/activities/${this.activityForm.id}`, this.activityForm);
                        } else {
                            await axios.post('http://localhost:8082/api/activities', this.activityForm);
                        }
                        this.showActivityModal = false;
                        this.loadActivities();
                        this.showMessage('ä¿å­˜æˆåŠŸ', 'success');
                    } catch (error) {
                        this.showMessage('ä¿å­˜å¤±è´¥: ' + error.message, 'error');
                    }
                },

                async deleteActivity(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªæ´»åŠ¨å—ï¼Ÿ')) return;
                    try {
                        await axios.delete(`http://localhost:8082/api/activities/${id}`);
                        this.loadActivities();
                        this.showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    } catch (error) {
                        this.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                    }
                },

                // Candidates
                async loadCandidates() {
                    if (!this.selectedActivityId) return;
                    try {
                        const response = await axios.get(`http://localhost:8082/api/admin/candidates?activityId=${this.selectedActivityId}`);
                        this.candidates = response.data.data || [];
                    } catch (error) {
                        console.error('åŠ è½½å€™é€‰äººå¤±è´¥:', error);
                    }
                },

                openAddCandidateModal() {
                    console.log('openAddCandidateModal è¢«è°ƒç”¨');
                    console.log('æ‰“å¼€å‰çš„ candidateForm:', this.candidateForm);
                    this.resetCandidateForm();
                    console.log('é‡ç½®åçš„ candidateForm:', this.candidateForm);
                    console.log('candidateForm.name:', this.candidateForm.name);
                    this.showCandidateModal = true;
                },

                editCandidate(candidate) {
                    this.candidateForm = { ...candidate, avatarPreview: candidate.avatar };
                    this.showCandidateModal = true;
                },

                triggerFileInput() {
                    this.$refs.fileInput.click();
                },

                handleImageUpload(event) {
                    const file = event.target.files[0];
                    if (!file) return;

                    // éªŒè¯æ–‡ä»¶ç±»å‹
                    if (!file.type.startsWith('image/')) {
                        this.showMessage('è¯·é€‰æ‹©å›¾ç‰‡æ–‡ä»¶', 'error');
                        return;
                    }

                    // éªŒè¯æ–‡ä»¶å¤§å°ï¼ˆé™åˆ¶ä¸º2MBï¼‰
                    if (file.size > 2 * 1024 * 1024) {
                        this.showMessage('å›¾ç‰‡å¤§å°ä¸èƒ½è¶…è¿‡2MB', 'error');
                        return;
                    }

                    this.uploadImage(file);
                },

                async uploadImage(file) {
                    console.log('uploadImage è¢«è°ƒç”¨ï¼Œæ–‡ä»¶:', file);
                    this.uploading = true;
                    this.uploadProgress = 0;

                    try {
                        const formData = new FormData();
                        formData.append('file', file);

                        console.log('å¼€å§‹ä¸Šä¼ æ–‡ä»¶åˆ°æœåŠ¡å™¨...');

                        const response = await axios.post('http://localhost:8082/api/upload/avatar', formData, {
                            headers: {
                                'Content-Type': 'multipart/form-data'
                            },
                            onUploadProgress: (progressEvent) => {
                                const percentCompleted = Math.round((progressEvent.loaded * 100) / progressEvent.total);
                                this.uploadProgress = percentCompleted;
                                console.log('ä¸Šä¼ è¿›åº¦:', percentCompleted + '%');
                            }
                        });

                        console.log('æœåŠ¡å™¨å“åº”:', response.data);

                        if (response.data.code === 200) {
                            const fileUrl = response.data.data.url;
                            console.log('æ–‡ä»¶URL:', fileUrl);
                            // å®Œæ•´URLç”¨äºé¢„è§ˆ
                            this.candidateForm.avatarPreview = 'http://localhost:8082' + fileUrl;
                            // ç›¸å¯¹è·¯å¾„ç”¨äºä¿å­˜åˆ°æ•°æ®åº“
                            this.candidateForm.avatar = fileUrl;
                            console.log('è®¾ç½® avatarPreview:', this.candidateForm.avatarPreview);
                            console.log('è®¾ç½® avatar:', this.candidateForm.avatar);
                            this.showMessage('å›¾ç‰‡ä¸Šä¼ æˆåŠŸ', 'success');
                        } else {
                            this.showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + response.data.message, 'error');
                        }
                    } catch (error) {
                        console.error('ä¸Šä¼ å¤±è´¥:', error);
                        console.error('é”™è¯¯è¯¦æƒ…:', error.response?.data);
                        this.showMessage('å›¾ç‰‡ä¸Šä¼ å¤±è´¥: ' + (error.response?.data?.message || error.message), 'error');
                    } finally {
                        this.uploading = false;
                    }
                },

                removeImage() {
                    this.candidateForm.avatar = null;
                    this.candidateForm.avatarPreview = null;
                    if (this.$refs.fileInput) {
                        this.$refs.fileInput.value = '';
                    }
                },

                async saveCandidate() {
                    console.log('saveCandidate è¢«è°ƒç”¨');
                    console.log('candidateForm:', this.candidateForm);
                    console.log('selectedActivityId:', this.selectedActivityId);
                    console.log('uploading:', this.uploading);
                    console.log('candidateForm.avatar:', this.candidateForm.avatar);

                    if (!this.selectedActivityId) {
                        this.showMessage('è¯·å…ˆé€‰æ‹©æ´»åŠ¨', 'error');
                        return;
                    }

                    if (!this.candidateForm.name) {
                        this.showMessage('è¯·è¾“å…¥å€™é€‰äººå§“å', 'error');
                        console.log('å§“åä¸ºç©º:', this.candidateForm.name);
                        return;
                    }

                    try {
                        const data = {
                            activityId: this.selectedActivityId,
                            name: this.candidateForm.name,
                            description: this.candidateForm.description,
                            orderNum: this.candidateForm.orderNum || 0,
                            status: 1
                        };

                        // å¦‚æœæœ‰ä¸Šä¼ å›¾ç‰‡ï¼Œä¿å­˜æ–‡ä»¶è·¯å¾„
                        if (this.candidateForm.avatar) {
                            data.avatar = this.candidateForm.avatar;
                            console.log('æ·»åŠ  avatar åˆ°æ•°æ®:', data.avatar);
                        } else {
                            console.log('æ²¡æœ‰ avatar æ•°æ®');
                        }

                        console.log('å‡†å¤‡å‘é€æ•°æ®:', data);
                        console.log('å€™é€‰äººID:', this.candidateForm.id);

                        let response;
                        if (this.candidateForm.id) {
                            response = await axios.put(`http://localhost:8082/api/admin/candidates/${this.candidateForm.id}`, data);
                        } else {
                            response = await axios.post('http://localhost:8082/api/admin/candidates', data);
                        }
                        console.log('åç«¯å“åº”:', response.data);

                        // å…ˆå…³é—­æ¨¡æ€æ¡†ï¼Œå†æ¸…ç©ºè¡¨å•å’Œåˆ·æ–°æ•°æ®
                        this.showCandidateModal = false;
                        setTimeout(() => {
                            this.resetCandidateForm();
                            this.loadCandidates();
                        }, 300);

                        this.showMessage('ä¿å­˜æˆåŠŸ', 'success');
                    } catch (error) {
                        console.error('ä¿å­˜å¤±è´¥:', error);
                        this.showMessage('ä¿å­˜å¤±è´¥: ' + (error.response?.data?.message || error.message), 'error');
                    }
                },

                resetCandidateForm() {
                    this.candidateForm = {
                        name: '',
                        description: '',
                        avatar: null,
                        avatarPreview: null,
                        orderNum: 0,
                        id: null
                    };
                    this.uploading = false;
                    this.uploadProgress = 0;
                    if (this.$refs.fileInput) {
                        this.$refs.fileInput.value = '';
                    }
                },

                async deleteCandidate(id) {
                    if (!confirm('ç¡®å®šè¦åˆ é™¤è¿™ä¸ªå€™é€‰äººå—ï¼Ÿ')) return;
                    try {
                        await axios.delete(`http://localhost:8082/api/admin/candidates/${id}`);
                        this.loadCandidates();
                        this.showMessage('åˆ é™¤æˆåŠŸ', 'success');
                    } catch (error) {
                        this.showMessage('åˆ é™¤å¤±è´¥: ' + error.message, 'error');
                    }
                },

                async adjustVotes(id, count) {
                    if (!count || count === 0) return;
                    try {
                        await axios.post(`http://localhost:8082/api/admin/candidates/${id}/votes/adjust`, null, {
                            params: { count: count }
                        });
                        this.loadCandidates();
                        this.showMessage('ç¥¨æ•°è°ƒæ•´æˆåŠŸ', 'success');
                    } catch (error) {
                        this.showMessage('è°ƒæ•´å¤±è´¥: ' + error.message, 'error');
                    }
                },

                // Statistics
                async loadStatistics() {
                    if (!this.statActivityId) return;
                    try {
                        const response = await axios.get(`http://localhost:8082/api/admin/statistics/${this.statActivityId}`);
                        this.activityStats = response.data.data;

                        // åŒæ—¶åŠ è½½è¶‹åŠ¿æ•°æ®å’Œå‚ä¸åº¦æ•°æ®
                        this.loadVoteTrends();
                        this.loadHourlyParticipation();

                        // åŠ è½½å®Œæˆååˆå§‹åŒ–å›¾è¡¨
                        this.$nextTick(() => {
                            this.initVoteTrendChart();
                            this.initVoteDistributionChart();
                            this.initHourlyParticipationChart();
                        });
                    } catch (error) {
                        console.error('åŠ è½½ç»Ÿè®¡æ•°æ®å¤±è´¥:', error);
                    }
                },

                async loadVoteTrends() {
                    if (!this.statActivityId) return;
                    try {
                        const response = await axios.get(`http://localhost:8082/api/admin/trends/${this.statActivityId}`);
                        this.voteTrends = response.data.data || [];
                        // é‡æ–°åˆå§‹åŒ–è¶‹åŠ¿å›¾
                        this.$nextTick(() => {
                            this.initVoteTrendChart();
                        });
                    } catch (error) {
                        console.error('åŠ è½½æŠ•ç¥¨è¶‹åŠ¿å¤±è´¥:', error);
                    }
                },

                async loadHourlyParticipation() {
                    if (!this.statActivityId) return;
                    try {
                        const response = await axios.get(`http://localhost:8082/api/admin/participation/${this.statActivityId}`);
                        this.hourlyParticipation = response.data.data || [];
                        // é‡æ–°åˆå§‹åŒ–æ—¶æ®µå‚ä¸åº¦å›¾
                        this.$nextTick(() => {
                            this.initHourlyParticipationChart();
                        });
                    } catch (error) {
                        console.error('åŠ è½½æ—¶æ®µå‚ä¸åº¦å¤±è´¥:', error);
                    }
                },

                initVoteTrendChart() {
                    const chartDom = document.getElementById('voteTrendChart');
                    if (!chartDom) return;

                    const myChart = echarts.init(chartDom);

                    const dates = this.voteTrends.map(t => t.date);
                    const votes = this.voteTrends.map(t => t.votes);

                    const option = {
                        title: {
                            text: 'æŠ•ç¥¨è¶‹åŠ¿'
                        },
                        tooltip: {
                            trigger: 'axis'
                        },
                        xAxis: {
                            type: 'category',
                            data: dates.length ? dates : ['1-01', '1-02', '1-03', '1-04', '1-05', '1-06', '1-07']
                        },
                        yAxis: {
                            type: 'value',
                            name: 'ç¥¨æ•°'
                        },
                        series: [{
                            data: votes.length ? votes : [100, 150, 200, 180, 220, 250, 300],
                            type: 'line',
                            smooth: true,
                            areaStyle: {
                                opacity: 0.3
                            },
                            itemStyle: {
                                color: '#667eea'
                            }
                        }]
                    };
                    myChart.setOption(option);
                },

                initVoteDistributionChart() {
                    const chartDom = document.getElementById('voteDistributionChart');
                    if (!chartDom || !this.activityStats) return;

                    const candidates = this.activityStats.candidates;
                    const names = candidates.map(c => c.name);
                    const votes = candidates.map(c => c.votes);

                    const myChart = echarts.init(chartDom);
                    const option = {
                        title: {
                            text: 'å€™é€‰äººå¾—ç¥¨åˆ†å¸ƒ'
                        },
                        tooltip: {
                            trigger: 'item',
                            formatter: '{b}: {c} ç¥¨ ({d}%)'
                        },
                        series: [{
                            type: 'pie',
                            radius: '60%',
                            data: candidates.map((c, index) => ({
                                value: c.votes,
                                name: c.name,
                                itemStyle: {
                                    color: [
                                        '#667eea', '#764ba2', '#f093fb', '#f5576c',
                                        '#4facfe', '#00f2fe', '#43e97b', '#38f9d7'
                                    ][index % 8]
                                }
                            })),
                            emphasis: {
                                itemStyle: {
                                    shadowBlur: 10,
                                    shadowOffsetX: 0,
                                    shadowColor: 'rgba(0, 0, 0, 0.5)'
                                }
                            },
                            label: {
                                show: true,
                                formatter: '{b}: {d}%'
                            }
                        }]
                    };
                    myChart.setOption(option);
                },

                initHourlyParticipationChart() {
                    const chartDom = document.getElementById('hourlyParticipationChart');
                    if (!chartDom) return;

                    const myChart = echarts.init(chartDom);

                    const hours = Array.from({length: 24}, (_, i) => `${i}:00`);
                    const voteCounts = Array(24).fill(0);
                    const uniqueVoters = Array(24).fill(0);

                    // å¡«å……å®é™…æ•°æ®
                    if (this.hourlyParticipation.length > 0) {
                        this.hourlyParticipation.forEach(item => {
                            const hour = item.hour || 0;
                            voteCounts[hour] = item.voteCount || 0;
                            uniqueVoters[hour] = item.uniqueVoters || 0;
                        });
                    }

                    const option = {
                        title: {
                            text: 'ä»Šæ—¥æ—¶æ®µå‚ä¸åº¦'
                        },
                        tooltip: {
                            trigger: 'axis',
                            axisPointer: {
                                type: 'cross'
                            }
                        },
                        legend: {
                            data: ['æŠ•ç¥¨æ•°', 'ç‹¬ç«‹äººæ•°']
                        },
                        xAxis: {
                            type: 'category',
                            data: hours
                        },
                        yAxis: {
                            type: 'value'
                        },
                        series: [
                            {
                                name: 'æŠ•ç¥¨æ•°',
                                type: 'bar',
                                data: voteCounts,
                                itemStyle: {
                                    color: '#667eea'
                                }
                            },
                            {
                                name: 'ç‹¬ç«‹äººæ•°',
                                type: 'line',
                                data: uniqueVoters,
                                itemStyle: {
                                    color: '#764ba2'
                                },
                                smooth: true
                            }
                        ]
                    };
                    myChart.setOption(option);
                },

                // Rate Limit Settings
                loadRateLimitSettings() {
                    const saved = localStorage.getItem('rate_limit_settings');
                    if (saved) {
                        this.rateLimit = JSON.parse(saved);
                    }
                },

                saveRateLimitSettings() {
                    localStorage.setItem('rate_limit_settings', JSON.stringify(this.rateLimit));
                    this.showMessage('è®¾ç½®å·²ä¿å­˜', 'success');
                },

                async exportReport() {
                    if (!this.statActivityId) {
                        this.showMessage('è¯·å…ˆé€‰æ‹©æ´»åŠ¨', 'error');
                        return;
                    }
                    try {
                        const response = await axios.get(`http://localhost:8082/api/admin/export/${this.statActivityId}`);
                        if (response.data.code === 200) {
                            this.showMessage('æŠ¥è¡¨å¯¼å‡ºè¯·æ±‚å·²å‘é€', 'success');
                        } else {
                            this.showMessage('å¯¼å‡ºå¤±è´¥: ' + response.data.message, 'error');
                        }
                    } catch (error) {
                        this.showMessage('å¯¼å‡ºå¤±è´¥: ' + error.message, 'error');
                    }
                },

                // Utilities
                showMessage(msg, type) {
                    this.message = msg;
                    this.messageType = type;
                    setTimeout(() => {
                        this.message = '';
                    }, 3000);
                },

                formatDate(dateStr) {
                    if (!dateStr) return '-';
                    const date = new Date(dateStr);
                    return date.toLocaleString('zh-CN');
                },

                getStatusText(status) {
                    const statusMap = {
                        1: 'è¿›è¡Œä¸­',
                        2: 'å·²ç»“æŸ',
                        3: 'å·²å–æ¶ˆ'
                    };
                    return statusMap[status] || 'æœªçŸ¥';
                },

                getAvatarUrl(avatar) {
                    if (!avatar) return '';
                    // å¦‚æœå·²ç»æ˜¯å®Œæ•´URLï¼Œç›´æ¥è¿”å›
                    if (avatar.startsWith('http://') || avatar.startsWith('https://')) {
                        return avatar;
                    }
                    // å¦åˆ™æ‹¼æ¥å®Œæ•´URL
                    return 'http://localhost:8082' + avatar;
                },

                limitDescriptionLength() {
                    if (this.candidateForm.description && this.candidateForm.description.length > 30) {
                        this.candidateForm.description = this.candidateForm.description.substring(0, 30);
                    }
                }
            }
        }).mount('#app');
    </script>
</body>
</html>
